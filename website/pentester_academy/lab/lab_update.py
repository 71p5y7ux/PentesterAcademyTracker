import bs4, sys
from bs4 import BeautifulSoup
import requests
from lab.models import Labs
# from course.models import Course as Labs
from django.utils.encoding import smart_str

def lab_update():
    cookies_jar = requests.cookies.RequestsCookieJar()
    cookies_jar.set('SACSID','Enter Cookie Here',domain='attackdefense.com',path='/')
    labUrl = 'https://attackdefense.com/'
    webpage=requests.get(labUrl,cookies=cookies_jar)
    # This stuff works
    soup = BeautifulSoup(webpage.text,'lxml')
    li_items = soup.find_all('li',{'class':'menu-item has-child'})
    try:
        for li_item in li_items:
            anchors = li_item.find_all('a')
            for a in anchors:
                if a['href']=='#':
                    span_element= a.find('span',{'class':'menu-text'})
                    course_name= smart_str(span_element.text)
                else:
                    topic_name=smart_str(a.text)
                    labLink = labUrl + a['href']
                    req=requests.get(labLink, cookies=cookies_jar)
                    soup = BeautifulSoup(req.text,'lxml')
                    sub_labs= soup.find_all('h3',{'class':'card-title text-truncate'})
                    for s in sub_labs:
                        lab_name = smart_str(s.text.strip())
                        # print ("Checking {} : {} : {}".format(course_name,topic_name,lab_name))
                        obj,created = Labs.objects.get_or_create(course_name=course_name,topic_name=topic_name,lab_name=lab_name)
                        if created:
                            obj.lab_link=smart_str(labLink).strip()
                            obj.save()
    except:
        print ("Error occured")

    return True
